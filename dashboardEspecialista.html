<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Especialista</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Dashboard Especialista</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <button class="btn btn-outline-danger" id="logoutButton">Cerrar Sesión</button>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container mt-5">
    <h3>Selecciona un Usuario</h3>
    <div id="usuariosLista"></div>
    
    <hr>

    <h4>Detalles del Usuario</h4>
    <div id="usuarioDetalles">
        <p><strong>Nombre:</strong> <span id="usuarioNombre"></span></p>
        <div id="calendar"></div>
        <button class="btn btn-primary mt-3" id="btnLlamar">Realizar Llamada</button>
    </div>
</div>

<!-- Modal para la llamada -->
<div class="modal fade" id="modalLlamada" tabindex="-1" aria-labelledby="modalLlamadaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLlamadaLabel">Llamada en curso</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div id="jitsiContainer"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js"></script>
<script src="https://meet.jit.si/external_api.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let selectedUserId = null;

        // Función para obtener la lista de usuarios
        function obtenerUsuarios() {
            fetch('/obtenerUsuarios.php') // Cambia esta URL con tu endpoint de usuarios
                .then(response => response.json())
                .then(data => {
                    const usuariosLista = document.getElementById('usuariosLista');
                    usuariosLista.innerHTML = ''; // Limpiar la lista

                    data.usuarios.forEach(usuario => {
                        const botonUsuario = document.createElement('button');
                        botonUsuario.classList.add('btn', 'btn-outline-primary', 'w-100', 'mb-2');
                        botonUsuario.innerText = `📞 ${usuario.nombre}`;
                        botonUsuario.onclick = () => mostrarDetallesUsuario(usuario.id);
                        usuariosLista.appendChild(botonUsuario);
                    });
                })
                .catch(error => console.error('Error al obtener usuarios:', error));
        }

        // Función para mostrar los detalles del usuario seleccionado
        function mostrarDetallesUsuario(usuarioId) {
            selectedUserId = usuarioId;
            fetch(`/obtenerDetallesUsuario.php?usuarioId=${usuarioId}`) // Cambia esta URL con tu endpoint para detalles de usuario
                .then(response => response.json())
                .then(data => {
                    document.getElementById('usuarioNombre').innerText = data.nombre;
                    renderizarCalendario(data.actividades);
                    document.getElementById('btnLlamar').onclick = () => iniciarLlamada(usuarioId);
                })
                .catch(error => console.error('Error al obtener detalles del usuario:', error));
        }

        // Función para renderizar el calendario
        function renderizarCalendario(actividades) {
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                events: actividades.map(actividad => ({
                    title: actividad.tipo + ": " + actividad.contenido,
                    start: actividad.fecha,
                    allDay: true
                }))
            });
            calendar.render();
        }

        // Función para iniciar la llamada con Jitsi
        function iniciarLlamada(usuarioId) {
            const roomName = `sala_${usuarioId}_${selectedUserId}`;
            const options = {
                roomName: roomName,
                width: '100%',
                height: '400px',
                parentNode: document.getElementById('jitsiContainer')
            };
            const api = new JitsiMeetExternalAPI('meet.jit.si', options);
            const modal = new bootstrap.Modal(document.getElementById('modalLlamada'));
            modal.show();
        }

        // Inicializar el Dashboard
        obtenerUsuarios();
    });
</script>
</body>
</html>
